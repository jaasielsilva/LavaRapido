<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::div})}">
<body>
    <div>
        <header>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 th:text="${agendamento.id == null ? 'Novo Agendamento' : 'Editar Agendamento'}">Agendamento</h1>
                    <div class="subtitle">Informe os dados do serviço</div>
                </div>
            </div>
        </header>

        <form th:action="@{/agendamentos/salvar}" th:object="${agendamento}" method="post" class="service-card p-4 mb-5">
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:field="*{status}" th:if="${agendamento.id == null}" /> <!-- Default status for new -->
            
            <div class="mb-4">
                <h2 class="h6 text-primary text-uppercase mb-3 fw-bold"><i class="fa-solid fa-car-side me-2"></i>Dados do veículo e cliente</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="veiculo" class="form-label text-light small fw-bold">Veículo</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-car"></i></span>
                            <select class="form-select bg-dark text-light border-secondary" id="veiculo" name="veiculoId" required>
                                <option value="">Selecione um veículo...</option>
                                <option th:each="v : ${veiculos}" 
                                        th:value="${v.id}" 
                                        th:text="${v.modelo + ' - ' + v.placa + ' (' + v.cliente.nome + ')'}"
                                        th:selected="${agendamento.veiculo != null && agendamento.veiculo.id == v.id}"
                                        th:data-fidelidade-count="${v.cliente.quantidadeLavagens != null ? v.cliente.quantidadeLavagens : 0}">
                                    Civic - ABC-1234 (João)
                                </option>
                            </select>
                        </div>
                        <small id="clienteInfo" class="text-info d-block mt-1 ms-1" style="font-size: 0.85em;">
                            <i class="fa-solid fa-circle-info me-1"></i>Cliente: selecione um veículo
                        </small>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="data" class="form-label text-light small fw-bold">Data e Hora</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-regular fa-calendar"></i></span>
                            <input type="datetime-local" class="form-control bg-dark text-light border-secondary" id="data" th:field="*{data}" required>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h2 class="h6 text-primary text-uppercase mb-3 fw-bold"><i class="fa-solid fa-wrench me-2"></i>Serviço e valor</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="servicoId" class="form-label text-light small fw-bold">Serviço (Catálogo)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-tags"></i></span>
                            <select class="form-select bg-dark text-light border-secondary" id="servicoId" name="servicoId">
                                <option value="">Selecione um serviço...</option>
                                <option th:each="s : ${catalogoServicos}"
                                        th:value="${s.id}"
                                        th:text="${s.nome}"
                                        th:data-preco="${s.preco}">
                                    Lavagem Completa
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="servicos" class="form-label text-light small fw-bold">Serviços (descrição personalizada)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-pen"></i></span>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="servicos" th:field="*{servicos}" placeholder="Ex: Lavagem Completa, Polimento...">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3" id="divFidelidade" style="display:none;">
                        <label class="form-label text-success small fw-bold"><i class="fa-solid fa-gift me-1"></i>Fidelidade</label>
                        <div class="p-2 border border-success rounded bg-success bg-opacity-10">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="usoFidelidade" th:field="*{usoFidelidade}">
                                <label class="form-check-label text-light fw-bold" for="usoFidelidade">
                                    Usar Lavagem Grátis
                                </label>
                            </div>
                            <small class="text-success d-block mt-1">Cliente possui <span id="spanPontos">0</span>/10 pontos</small>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="valorMascara" class="form-label text-light small fw-bold">Valor Total</label>
                        <input type="hidden" id="valor" th:field="*{valor}">
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-success border-secondary fw-bold">R$</span>
                            <input type="text"
                                   class="form-control bg-dark text-light border-secondary text-end fw-bold fs-5"
                                   id="valorMascara"
                                   inputmode="decimal"
                                   placeholder="0,00">
                        </div>
                        <small class="text-secondary d-block mt-1 ms-1" style="font-size: 0.85em;">
                            Preenchido automaticamente ao selecionar serviço.
                        </small>
                    </div>
                    
                    <div class="col-md-4 mb-3" th:if="${agendamento.id != null}">
                        <label for="statusSelect" class="form-label text-light small fw-bold">Status</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-bars-progress"></i></span>
                            <select class="form-select bg-dark text-light border-secondary" id="statusSelect" th:field="*{status}">
                                <option th:each="s : ${T(br.com.lavajato.model.agendamento.StatusAgendamento).values()}"
                                        th:value="${s}" th:text="${s.descricao}">Agendado</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="h6 text-primary text-uppercase mb-3 fw-bold"><i class="fa-regular fa-comment-dots me-2"></i>Observações</h2>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-pencil"></i></span>
                    <textarea class="form-control bg-dark text-light border-secondary" id="observacoes"
                              th:field="*{observacoes}"
                              rows="3"
                              placeholder="Ex: Cliente vai aguardar no local, pagamento em dinheiro, etc."></textarea>
                </div>
            </div>

            <div class="d-flex gap-2 justify-content-end mt-5 pt-3 border-top border-secondary border-opacity-10">
                <a th:href="@{/agendamentos}" class="btn btn-outline-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4 fw-bold">
                    <i class="fa-solid fa-save me-2"></i>Salvar Agendamento
                </button>
            </div>
        </form>
        
        <script th:inline="javascript">
        /*<![CDATA[*/
            document.addEventListener('DOMContentLoaded', function () {
                var agendamentoErro = /*[[${agendamentoErro}]]*/ null;
                if (agendamentoErro) {
                    Swal.fire({
                        title: 'Atenção',
                        text: agendamentoErro,
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        background: '#0f1623',
                        color: '#fff'
                    });
                }

                var servicoSelect = document.getElementById('servicoId');
                var servicosInput = document.getElementById('servicos');
                var valorHidden = document.getElementById('valor');
                var valorMascara = document.getElementById('valorMascara');
                var veiculoSelect = document.getElementById('veiculo');
                var clienteInfo = document.getElementById('clienteInfo');
                
                // Fidelidade
                var divFidelidade = document.getElementById('divFidelidade');
                var checkFidelidade = document.getElementById('usoFidelidade');
                var spanPontos = document.getElementById('spanPontos');
                var valorAnterior = '';

                function verificarFidelidade() {
                    if (!veiculoSelect || !divFidelidade) return;
                    
                    var opt = veiculoSelect.options[veiculoSelect.selectedIndex];
                    if (opt && opt.getAttribute('data-fidelidade-count')) {
                        var pontos = parseInt(opt.getAttribute('data-fidelidade-count'));
                        if (spanPontos) spanPontos.textContent = pontos;
                        
                        // Se já estiver marcado (edição), mostra independente dos pontos atuais (pois já descontou ou é visualização)
                        // Mas aqui os pontos já foram descontados se foi salvo.
                        // Se é edição e já está marcado, mostra.
                        // Se é novo e tem >= 10, mostra.
                        
                        var isChecked = checkFidelidade.checked;
                        
                        if (pontos >= 10 || isChecked) {
                            divFidelidade.style.display = 'block';
                        } else {
                            divFidelidade.style.display = 'none';
                            checkFidelidade.checked = false; // Uncheck se mudar para veículo sem pontos
                            toggleValorFidelidade(); // Restaura valor
                        }
                    } else {
                        divFidelidade.style.display = 'none';
                        if (checkFidelidade) checkFidelidade.checked = false;
                    }
                }

                function toggleValorFidelidade() {
                    if (!checkFidelidade || !valorMascara || !valorHidden) return;
                    
                    if (checkFidelidade.checked) {
                        if (valorHidden.value && valorHidden.value !== '0.00') {
                            valorAnterior = valorHidden.value;
                        }
                        valorHidden.value = '0.00';
                        valorMascara.value = '0,00';
                        valorMascara.readOnly = true;
                        valorMascara.classList.add('text-muted');
                    } else {
                        valorMascara.readOnly = false;
                        valorMascara.classList.remove('text-muted');
                        if (valorAnterior) {
                            valorHidden.value = valorAnterior;
                            valorMascara.value = formatarMoeda(parseFloat(valorAnterior));
                        }
                    }
                }

                if (veiculoSelect) {
                    veiculoSelect.addEventListener('change', function() {
                        atualizarCliente(); // Existing function
                        verificarFidelidade();
                    });
                    // Verifica ao carregar
                    verificarFidelidade();
                }
                
                if (checkFidelidade) {
                    checkFidelidade.addEventListener('change', toggleValorFidelidade);
                    // Aplica estado inicial
                    if (checkFidelidade.checked) {
                        valorMascara.readOnly = true;
                        valorMascara.classList.add('text-muted');
                    }
                }

                function formatarMoeda(valorNumerico) {
                    if (isNaN(valorNumerico)) {
                        return '';
                    }
                    var negativo = valorNumerico < 0;
                    valorNumerico = Math.abs(valorNumerico);
                    var inteiro = Math.floor(valorNumerico);
                    var centavos = Math.round((valorNumerico - inteiro) * 100);
                    if (centavos === 100) {
                        inteiro += 1;
                        centavos = 0;
                    }
                    var inteiroStr = inteiro.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    var centavosStr = centavos.toString().padStart(2, '0');
                    return (negativo ? '-' : '') + inteiroStr + ',' + centavosStr;
                }

                function parseMoedaParaNumero(texto) {
                    if (!texto) {
                        return null;
                    }
                    var limpo = texto.toString().replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]/g, '');
                    var numero = parseFloat(limpo);
                    return isNaN(numero) ? null : numero;
                }

                if (valorHidden && valorMascara && valorHidden.value) {
                    var numeroInicial = parseFloat(valorHidden.value);
                    var formatadoInicial = formatarMoeda(numeroInicial);
                    if (formatadoInicial) {
                        valorMascara.value = formatadoInicial;
                    }
                }

                if (valorMascara && valorHidden) {
                    valorMascara.addEventListener('blur', function () {
                        var numero = parseMoedaParaNumero(this.value);
                        if (numero !== null) {
                            valorHidden.value = numero.toFixed(2);
                            this.value = formatarMoeda(numero);
                        } else {
                            valorHidden.value = '';
                            this.value = '';
                        }
                    });
                }

                if (servicoSelect) {
                    servicoSelect.addEventListener('change', function () {
                        var option = this.options[this.selectedIndex];
                        var nome = option.text || '';
                        var preco = option.getAttribute('data-preco');

                        if (nome && servicosInput && !servicosInput.value) {
                            servicosInput.value = nome;
                        }

                        if (preco && valorHidden && valorMascara) {
                             // O data-preco vem do backend (BigDecimal.toString()), ex: "40.00" ou "4000.00" (se formatado errado)
                             // O problema relatado (4.000,00) sugere que o JS está interpretando "40.00" ou "40" de forma errada na formatação
                             // ou o parseMoedaParaNumero estava removendo o ponto incorretamente.
                             
                             // Solução robusta: tratar como float puro, pois vem do atributo HTML data-preco="${s.preco}"
                             // BigDecimal no Java vira "40.00" no HTML (padrão US).
                             
                             var numero = parseFloat(preco);
                             
                             if (!isNaN(numero)) {
                                 valorHidden.value = numero.toFixed(2);
                                 valorMascara.value = formatarMoeda(numero);
                             }
                        }
                    });
                }

                if (veiculoSelect && clienteInfo) {
                    function atualizarCliente() {
                        var opt = veiculoSelect.options[veiculoSelect.selectedIndex];
                        if (opt && opt.text) {
                            var txt = opt.text;
                            var ini = txt.indexOf('(');
                            var fim = txt.lastIndexOf(')');
                            if (ini !== -1 && fim !== -1 && fim > ini) {
                                var nome = txt.substring(ini + 1, fim);
                                clienteInfo.innerHTML = '<i class="fa-solid fa-user me-1"></i>Cliente: <strong>' + nome + '</strong>';
                                return;
                            }
                        }
                        clienteInfo.innerHTML = '<i class="fa-solid fa-circle-info me-1"></i>Cliente: selecione um veículo';
                    }
                    veiculoSelect.addEventListener('change', atualizarCliente);
                    atualizarCliente();
                }
            });
        /*]]>*/
        </script>

        <style>
            /* Estilo Premium para o Formulário (igual ao Service Card) */
            .service-card {
                background-color: #0f1623;
                border: 1px solid #1e293b;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            /* Inputs com foco elegante */
            .form-control:focus, .form-select:focus {
                background-color: #1e293b;
                border-color: #0ea5e9;
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25);
                color: #fff;
            }

            /* Input Groups */
            .input-group-text {
                background-color: #1e293b;
                border-color: #334155;
            }

            /* Labels */
            .form-label {
                letter-spacing: 0.5px;
                text-transform: uppercase;
                font-size: 0.75rem;
                color: #94a3b8 !important; /* Secondary color for labels */
            }

            /* Botões */
            .btn-primary {
                background-color: #0ea5e9;
                border-color: #0ea5e9;
            }
            .btn-primary:hover {
                background-color: #0284c7;
                border-color: #0284c7;
            }
        </style>
    </div>
</body>
</html>
