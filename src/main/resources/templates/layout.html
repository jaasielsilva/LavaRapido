<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:fragment="layout(conteudoPagina)">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Lava-Jato SaaS</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
</head>

<body>

<div class="sidebar">
    <div class="sidebar-main">
        <div class="logo">
            <div class="logo-icon" th:if="${empresaLogada == null || empresaLogada.logo == null}">
                <i class="fa-solid fa-car"></i>
            </div>
            <div class="logo-icon" th:if="${empresaLogada != null && empresaLogada.logo != null}" style="background: none; padding: 0;">
                <img th:src="${empresaLogada.logo}" alt="Logo" style="max-width: 100%; max-height: 40px; border-radius: 6px;" />
            </div>
            
            <div class="logo-text">
                <strong th:text="${empresaLogada != null ? empresaLogada.nome : 'Lava Jato SaaS'}">AutoShine</strong>
                <span>Estética Automotiva</span>
            </div>
        </div>

        <div class="menu">
            <!-- OPERACIONAL -->
            <div class="menu-label mt-2 px-3 mb-2" style="font-size: 10px; font-weight: 700; color: var(--text-secondary); opacity: 0.6; text-transform: uppercase;">Operacional</div>
            
            <a th:href="@{/dashboard}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI == '/dashboard' ? 'active' : ''}">
                <i class="fa-solid fa-table-columns"></i>
                <span>Dashboard</span>
            </a>

            <a th:href="@{/clientes}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/clientes') ? 'active' : ''}">
                <i class="fa-solid fa-users"></i>
                <span>Clientes</span>
            </a>

            <a th:href="@{/agendamentos}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/agendamentos') ? 'active' : ''}">
                <i class="fa-solid fa-calendar-days"></i>
                <span>Agendamentos</span>
            </a>

            <a th:href="@{/servicos-avulsos}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/servicos-avulsos') ? 'active' : ''}">
                <i class="fa-solid fa-wrench"></i>
                <span>Abrir OS</span>
            </a>
            
            <a th:href="@{/veiculos}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/veiculos') ? 'active' : ''}">
                <i class="fa-solid fa-car-side"></i>
                <span>Veículos</span>
            </a>

            <!-- GESTÃO (ADMIN/MASTER) -->
            <div sec:authorize="hasAnyRole('MASTER','ADMIN')">
                <div class="menu-label mt-4 px-3 mb-2" style="font-size: 10px; font-weight: 700; color: var(--text-secondary); opacity: 0.6; text-transform: uppercase;">Gestão & Financeiro</div>
                
                <a th:href="@{/usuarios}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/usuarios') ? 'active' : ''}">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Funcionários</span>
                </a>

                <a th:href="@{/financeiro}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/financeiro') ? 'active' : ''}">
                    <i class="fa-solid fa-cash-register"></i>
                    <span>Fluxo de Caixa</span>
                </a>

                <a th:href="@{/produtos}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/produtos') ? 'active' : ''}">
                    <i class="fa-solid fa-box-open"></i>
                    <span>Produtos</span>
                </a>
                
                <a th:href="@{/catalogo}" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/catalogo') ? 'active' : ''}">
                    <i class="fa-solid fa-tags"></i>
                    <span>Catálogo</span>
                </a>
                
                <a th:href="@{/empresas}" sec:authorize="hasRole('MASTER')" th:classappend="${#httpServletRequest != null && #httpServletRequest.requestURI.startsWith('/empresas') ? 'active' : ''}">
                    <i class="fa-solid fa-building"></i>
                    <span>Empresas</span>
                </a>
            </div>
        </div>
    </div>

    <div class="sidebar-footer">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-link">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span>Sair</span>
            </button>
        </form>

        <div class="version">
            Lava Jato SaaS<br><strong>v1.0.0</strong>
        </div>
    </div>
</div>

<main class="main">
    <div th:replace="${conteudoPagina}"></div>
</main>

<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script th:src="@{/js/app.js}"></script>

<script>
    // Set global para rastrear IDs de notificações já exibidas na sessão atual
    // Isso evita que o Toast seja recriado/pisque a cada polling de 30s
    // Mas permite que ele persista na tela.
    const notificacoesExibidas = new Set();

    document.addEventListener('DOMContentLoaded', function() {
        // Verifica notificações a cada 30 segundos
        setInterval(verificarNotificacoes, 30000);
        // Verifica imediatamente ao carregar
        verificarNotificacoes();
    });

    function verificarNotificacoes() {
        fetch('/api/notificacoes/check')
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    // Se houver notificações ativas vindas do backend
                    data.forEach(notificacao => {
                        // Só exibe se ainda não estiver na tela/rastreada
                        if (!notificacoesExibidas.has(notificacao.id)) {
                            exibirNotificacao(notificacao);
                            notificacoesExibidas.add(notificacao.id);
                        }
                    });
                }
                
                // Opcional: Limpar do Set se não vier mais no backend? 
                // Não precisa, pois se sumiu do backend (expirou), o frontend não precisa fechar forçado,
                // mas se o usuário recarregar a página, não aparecerá mais.
                // Se quisermos fechar o Toast quando expirar em tempo real, precisaríamos guardar a referência do Swal.
                // Mas o requisito "não aparecer mais" geralmente se refere a novas exibições.
            })
            .catch(error => console.error('Erro ao verificar notificações:', error));
    }

    function exibirNotificacao(notificacao) {
        // Alerta Sutil (Toast no canto superior direito)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: true,
            confirmButtonText: '<i class="fa-solid fa-check"></i> Lido',
            showCancelButton: !!notificacao.link,
            cancelButtonText: '<i class="fa-solid fa-eye"></i> Ver',
            timer: null, // SEM TIMER - Fica até clicar ou recarregar (se expirado)
            timerProgressBar: false,
            width: '400px',
            padding: '1rem',
            customClass: {
                confirmButton: 'btn btn-sm btn-outline-success ms-1',
                cancelButton: 'btn btn-sm btn-outline-primary ms-1'
            },
            buttonsStyling: false,
            didOpen: (toast) => {
                // Não precisa mais de pause/resume timer
            }
        });

        Toast.fire({
            icon: 'info',
            title: notificacao.titulo,
            text: notificacao.mensagem
        }).then((result) => {
            // Ao interagir (fechar, lido, ver), removemos do set para permitir re-exibir se o backend mandar de novo (improvável se marcado lido)
            notificacoesExibidas.delete(notificacao.id);

            if (result.isConfirmed) {
                // Clicou em Lido
                marcarComoLida(notificacao.id);
            } else if (result.dismiss === Swal.DismissReason.cancel && notificacao.link) {
                // Clicou em Ver
                marcarComoLida(notificacao.id);
                window.location.href = notificacao.link;
            } else {
                // Fechou no X ou clicou fora (se configurado, mas toast geralmente não fecha clicando fora)
                // Se fechou manualmente, marca como lida? O usuário pediu "até clicar em lido".
                // Mas se ele fecha no X, subentende-se lido. Vamos marcar.
                marcarComoLida(notificacao.id);
            }
        });
    }

    function marcarComoLida(id) {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        
        fetch('/api/notificacoes/' + id + '/ler', { 
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            }
        })
            .catch(err => console.error('Erro ao marcar notificação como lida', err));
    }
</script>
</body>
</html>
