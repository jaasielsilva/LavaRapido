<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::div})}">

<body>
    <div>
        <style>
            /* Layout & Common */
            .list-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            /* Item Row - Floating Style */
            .item-row {
                background: #0f1623;
                border: 1px solid #1e293b;
                border-radius: 16px;
                padding: 15px 25px;
                display: grid;
                grid-template-columns: 80px 2fr 1.5fr 1fr 1fr 140px;
                align-items: center;
                gap: 20px;
                transition: all 0.2s ease;
                position: relative;
            }

            /* Default Hover: Blue (Matches Agendamentos) */
            .item-row:hover {
                transform: translateY(-2px);
                border-color: #38bdf8 !important;
                /* Azul */
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
                z-index: 10;
            }

            /* Estado Atrasado (Used for Low Stock here): Vermelho Pulsante no Hover */
            .item-row.baixo-estoque:hover {
                border-color: #ef4444 !important;
                /* Vermelho */
                animation: pulse-red 1.5s infinite;
            }

            /* Visual indication for low stock items (ALWAYS VISIBLE) */
            .item-row.baixo-estoque {
                border-color: #ef4444 !important;
                /* Solid Red */
                background: rgba(239, 68, 68, 0.05);
                /* Slight tint */
            }

            @keyframes pulse-red {
                0% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                }
            }

            /* Badge Pop Animation */
            @keyframes badge-pop {
                0% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.4);
                }

                100% {
                    transform: scale(1);
                }
            }

            .badge-animate {
                animation: badge-pop 0.3s ease-out;
            }

            /* Toast Notification */
            .custom-toast {
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: #0f1623;
                border: 1px solid #38bdf8;
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
                z-index: 10000;
                transform: translateY(100px);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .custom-toast.show {
                transform: translateY(0);
                opacity: 1;
            }

            /* Icon Wrapper */
            .item-icon {
                display: flex;
                flex-direction: column;
                align-items: center;
                border-right: 1px solid rgba(255, 255, 255, 0.05);
                padding-right: 20px;
            }

            .item-icon i {
                font-size: 24px;
                color: #38bdf8;
            }

            /* Main Info */
            .item-main {
                display: flex;
                align-items: center;
                gap: 15px;
                min-width: 0;
            }

            .info-content .primary-text {
                font-weight: 600;
                color: white;
                font-size: 15px;
                margin-bottom: 2px;
            }

            .secondary-text {
                font-size: 13px;
                color: #94a3b8;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Category Section */
            .item-category {
                min-width: 0;
            }

            .label-text {
                font-size: 10px;
                text-transform: uppercase;
                color: #475569;
                font-weight: 700;
                margin-bottom: 2px;
            }

            .value-text {
                color: #cbd5e1;
                font-size: 14px;
            }

            /* Status Section */
            .item-status {
                text-align: center;
            }

            .badge-status {
                display: inline-block;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-green {
                background: rgba(34, 197, 94, 0.15);
                color: #4ade80;
            }

            .status-red {
                background: rgba(239, 68, 68, 0.15);
                color: #f87171;
            }

            .bg-soft-primary {
                background: rgba(14, 165, 233, 0.2);
                color: #38bdf8;
            }

            .bg-soft-warning {
                background: rgba(245, 158, 11, 0.2);
                color: #fbbf24;
            }

            .bg-soft-success {
                background: rgba(34, 197, 94, 0.2);
                color: #4ade80;
            }

            .bg-soft-danger {
                background: rgba(239, 68, 68, 0.2);
                color: #f87171;
            }

            .bg-soft-secondary {
                background: rgba(148, 163, 184, 0.2);
                color: #94a3b8;
            }

            /* End Section */
            .item-end {
                display: flex;
                align-items: center;
                gap: 20px;
                padding-left: 20px;
                border-left: 1px solid rgba(255, 255, 255, 0.05);
            }

            .price-tag {
                font-weight: 700;
                color: #4ade80;
                font-size: 16px;
                white-space: nowrap;
            }

            .btn-action-trigger {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: transparent;
                color: #94a3b8;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .btn-action-trigger:hover,
            .btn-action-trigger[aria-expanded="true"] {
                background: rgba(255, 255, 255, 0.05);
                color: white;
            }

            /* Search Bar */
            .search-bar {
                background: #0f1623;
                border: 1px solid #1e293b;
                border-radius: 12px;
                padding: 10px 15px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .search-bar input {
                background: transparent;
                border: none;
                color: white;
                font-size: 14px;
                width: 100%;
                outline: none;
            }

            .search-bar i {
                color: #475569;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                background: #0f1623;
                border-radius: 20px;
                border: 1px dashed #334155;
            }

            .empty-state .icon-circle {
                width: 80px;
                height: 80px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 32px;
                color: #475569;
            }

            /* Modal Styles */
            .modal-content {
                border-radius: 24px !important;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
                background: linear-gradient(145deg, #0f1623 0%, #0b101b 100%) !important;
                border: 1px solid rgba(255, 255, 255, 0.05) !important;
            }

            .modal-header {
                padding: 24px 24px 16px 24px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .form-control,
            .form-select {
                background: rgba(0, 0, 0, 0.2) !important;
                border: 1px solid #334155 !important;
                color: white !important;
                border-radius: 10px;
            }

            .form-control:focus,
            .form-select:focus {
                border-color: #38bdf8 !important;
                box-shadow: 0 0 10px rgba(56, 189, 248, 0.1) !important;
            }

            .currency-input-wrapper {
                position: relative;
            }

            .currency-input-wrapper .prefix {
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #475569;
                font-size: 14px;
                pointer-events: none;
            }

            .currency-input-wrapper input {
                padding-left: 35px;
            }
        </style>

        <!-- Header -->
        <header class="mb-4 d-flex justify-content-between align-items-end">
            <div>
                <h1>Produtos</h1>
                <div class="subtitle">Gestão de estoque e catálogo</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary position-relative px-4" id="btnAbrirVenda"
                    data-bs-toggle="modal" data-bs-target="#modalFinalizarVenda">
                    <i class="fa-solid fa-cart-shopping me-2"></i> Carrinho
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info"
                        id="badgeCarrinho">0</span>
                </button>
                <button class="btn btn-secondary px-4 d-flex align-items-center gap-2" data-bs-toggle="modal"
                    data-bs-target="#modalScanner" id="btnScanner">
                    <i class="fa-solid fa-barcode"></i> Scanner
                </button>
                <button class="btn btn-primary px-4 d-flex align-items-center gap-2" data-bs-toggle="modal"
                    data-bs-target="#modalNovoProduto" id="btnNovoProduto">
                    <i class="fa-solid fa-plus"></i> Novo Produto
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="cards mb-5">
            <div class="card blue">
                <div class="card-info">
                    <div>
                        <h4>TOTAL PRODUTOS</h4>
                        <div class="number" th:text="${totalProdutos}">0</div>
                    </div>
                    <div class="stat">
                        <span class="muted">Itens cadastrados</span>
                    </div>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-box"></i>
                </div>
            </div>

            <div class="card orange">
                <div class="card-info">
                    <div>
                        <h4>ESTOQUE BAIXO</h4>
                        <div class="number" th:text="${estoqueBaixo}">0</div>
                    </div>
                    <div class="stat">
                        <span class="muted">Requer atenção</span>
                    </div>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
            </div>

            <div class="card green">
                <div class="card-info">
                    <div>
                        <h4>VALOR EM ESTOQUE</h4>
                        <div class="number"
                            th:text="'R$ ' + ${#numbers.formatDecimal(valorEstoque != null ? valorEstoque : 0, 0, 'POINT', 2, 'COMMA')}">
                            R$ 0,00</div>
                    </div>
                    <div class="stat">
                        <span class="muted">Patrimônio total</span>
                    </div>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <form th:action="@{/produtos}" method="get" class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="search-bar">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" name="busca" th:value="${busca}" placeholder="Buscar por nome ou descrição...">
                </div>
            </div>
            <div class="col-md-3">
                <select name="categoria" class="form-select">
                    <option value="">Todas Categorias</option>
                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat.descricao}"
                        th:selected="${cat == categoriaSelecionada}">Categoria</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-secondary w-100"><i class="fa-solid fa-filter"></i></button>
            </div>
        </form>

        <!-- Products List -->
        <div class="list-container">
            <div th:if="${#lists.isEmpty(produtos.content)}" class="empty-state">
                <div class="icon-circle">
                    <i class="fa-solid fa-box-open"></i>
                </div>
                <h3>Nenhum produto encontrado</h3>
                <p>Ajuste os filtros ou adicione um novo produto.</p>
            </div>

            <div th:each="produto : ${produtos.content}" class="item-row"
                th:classappend="${produto.estoque <= (produto.estoqueMinimo != null ? produto.estoqueMinimo : 0)} ? 'baixo-estoque' : ''">

                <!-- Icon -->
                <div class="item-icon">
                    <i
                        th:class="${produto.categoria != null ? (
                        produto.categoria.name() == 'CERA' ? 'fa-solid fa-spray-can-sparkles' : 
                        produto.categoria.name() == 'SHAMPOO' ? 'fa-solid fa-soap' : 
                        produto.categoria.name() == 'SILICONE' ? 'fa-solid fa-bottle-droplet' : 
                        produto.categoria.name() == 'AROMATIZANTE' ? 'fa-solid fa-wind' : 
                        produto.categoria.name() == 'ACESSORIO' ? 'fa-solid fa-bucket' : 'fa-solid fa-box') : 'fa-solid fa-box'}"></i>
                </div>

                <!-- Main Info -->
                <div class="item-main">
                    <div class="info-content">
                        <div class="primary-text" th:text="${produto.nome}">Nome do Produto</div>
                        <div class="secondary-text" th:text="${produto.descricao != null ? produto.descricao : '-'}">
                            Descrição do produto</div>
                    </div>
                </div>

                <!-- Category & Unit -->
                <div class="item-category">
                    <div class="label-text">CATEGORIA</div>
                    <div class="value-text d-flex align-items-center gap-2">
                        <span class="badge rounded-pill fw-semibold px-2 py-1"
                            th:classappend="'bg-soft-' + (produto.categoria != null ? produto.categoria.cor : 'secondary')"
                            th:text="${produto.categoria != null ? produto.categoria.descricao : 'Outros'}">Categoria</span>
                        <span class="text-secondary small fw-bold"
                            th:text="'(' + ${produto.unidade != null ? produto.unidade.sigla : 'UN'} + ')'">UN</span>
                    </div>
                </div>

                <!-- Stock Status -->
                <div class="item-status text-start">
                    <div class="label-text">ESTOQUE ATUAL</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold fs-5"
                            th:classappend="${produto.estoque <= (produto.estoqueMinimo != null ? produto.estoqueMinimo : 0)} ? 'text-danger' : 'text-white'"
                            th:text="${produto.estoque}">10</span>
                        <span class="text-secondary small"
                            th:text="${produto.unidade != null ? produto.unidade.descricao : 'Unid.'}">Unid.</span>
                        <i class="fa-solid fa-triangle-exclamation text-danger ms-1"
                            th:if="${produto.estoque <= (produto.estoqueMinimo != null ? produto.estoqueMinimo : 0)}"
                            title="Estoque Baixo"></i>
                    </div>
                </div>

                <!-- Price -->
                <div class="item-end">
                    <div class="price-tag"
                        th:text="'R$ ' + ${#numbers.formatDecimal(produto.precoVenda != null ? produto.precoVenda : 0, 1, 'POINT', 2, 'COMMA')}">
                        R$ 0,00</div>

                    <div class="d-flex gap-2">
                        <!-- Botão Adicionar ao Carrinho -->
                        <button class="btn-action-trigger btn-add-carrinho" type="button" title="Adicionar ao Carrinho"
                            th:data-id="${produto.id}" th:data-nome="${produto.nome}"
                            th:data-preco="${produto.precoVenda}" th:data-estoque="${produto.estoque}">
                            <i class="fa-solid fa-cart-plus"></i>
                        </button>

                        <!-- Botão Editar -->
                        <button class="btn-action-trigger btn-edit-produto" type="button" title="Editar"
                            th:data-id="${produto.id}" th:data-nome="${produto.nome}"
                            th:data-descricao="${produto.descricao}" th:data-preco-venda="${produto.precoVenda}"
                            th:data-preco-custo="${produto.precoCusto}" th:data-estoque="${produto.estoque}"
                            th:data-estoque-minimo="${produto.estoqueMinimo}" th:data-categoria="${produto.categoria}"
                            th:data-unidade="${produto.unidade}" th:data-ean="${produto.ean}">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav th:if="${produtos.totalPages > 1}" class="mt-4">
            <ul class="pagination justify-content-center pagination-dark">
                <li class="page-item" th:classappend="${produtos.first} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/produtos(page=${produtos.number - 1}, busca=${busca}, categoria=${categoriaSelecionada})}">
                        &larr; Anterior
                    </a>
                </li>
                <li class="page-item active">
                    <span class="page-link" th:text="${produtos.number + 1}">1</span>
                </li>
                <li class="page-item" th:classappend="${produtos.last} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/produtos(page=${produtos.number + 1}, busca=${busca}, categoria=${categoriaSelecionada})}">
                        Próximo &rarr;
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Modal: Novo/Editar Produto -->
        <div class="modal fade" id="modalNovoProduto" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="modalTituloProduto">Novo Produto</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/produtos/salvar}" method="post" th:object="${novoProduto}">
                        <div class="modal-body p-4">
                            <input type="hidden" th:field="*{id}" id="produtoId" />

                            <div class="mb-3">
                                <label class="form-label small fw-bold">NOME DO PRODUTO *</label>
                                <input type="text" class="form-control" th:field="*{nome}"
                                    placeholder="Ex: Cera Cristalizadora" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">DESCRIÇÃO</label>
                                <textarea class="form-control" th:field="*{descricao}"
                                    placeholder="Detalhes do produto..." rows="2"></textarea>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">PREÇO VENDA *</label>
                                    <div class="currency-input-wrapper">
                                        <span class="prefix">R$</span>
                                        <input type="text" class="form-control currency-mask" id="precoVendaDisplay"
                                            placeholder="0,00" required>
                                        <input type="hidden" th:field="*{precoVenda}" id="precoVenda">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">PREÇO CUSTO</label>
                                    <div class="currency-input-wrapper">
                                        <span class="prefix">R$</span>
                                        <input type="text" class="form-control currency-mask" id="precoCustoDisplay"
                                            placeholder="0,00">
                                        <input type="hidden" th:field="*{precoCusto}" id="precoCusto">
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">ESTOQUE ATUAL</label>
                                    <input type="number" class="form-control" th:field="*{estoque}" placeholder="0">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">ESTOQUE MÍNIMO</label>
                                    <input type="number" class="form-control" th:field="*{estoqueMinimo}"
                                        placeholder="5">
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">CATEGORIA *</label>
                                    <select class="form-select" th:field="*{categoria}" required>
                                        <option th:each="cat : ${categorias}" th:value="${cat}"
                                            th:text="${cat.descricao}"></option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">UNIDADE *</label>
                                    <select class="form-select" th:field="*{unidade}" required>
                                        <option th:each="un : ${unidades}" th:value="${un}" th:text="${un.descricao}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">CÓDIGO EAN</label>
                                <input type="text" class="form-control" th:field="*{ean}" placeholder="Digite ou escaneie o código de barras">
                            </div>
                        </div>
                        <div class="modal-footer border-0 p-4 pt-0">
                            <button type="submit" class="btn btn-primary w-100 fw-bold py-2"
                                id="btnSubmitProduto">CADASTRAR PRODUTO</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Modal: Scanner de Produtos -->
        <div class="modal fade" id="modalScanner" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Scanner de Produtos</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/produtos/scan}" method="post">
                        <div class="modal-body p-4">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">CÓDIGO EAN</label>
                                <input type="text" class="form-control" name="ean" id="scanEan" placeholder="Aponte o leitor e bip" autofocus>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">QUANTIDADE</label>
                                <input type="number" class="form-control" name="quantidade" id="scanQtd" value="1" min="1">
                            </div>
                            <p class="text-secondary small">Se o EAN existir, o estoque será incrementado. Se não existir, será solicitado o cadastro com dados do produto.</p>
                        </div>
                        <div class="modal-footer border-0 p-4 pt-0">
                            <button type="submit" class="btn btn-secondary w-100 fw-bold py-2">
                                Processar Leitura
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal: Carrinho de Vendas -->
        <div class="modal fade" id="modalFinalizarVenda" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Finalizar Venda</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="row g-0">
                            <!-- Items -->
                            <div class="col-md-7 p-4 border-end border-secondary border-opacity-10">
                                <h6 class="text-info mb-3 d-flex align-items-center gap-2">
                                    <i class="fa-solid fa-list-ul"></i> ITENS DO PEDIDO
                                </h6>
                                <div id="listaItensVenda" class="d-flex flex-column gap-2 overflow-auto"
                                    style="max-height: 350px;">
                                    <div class="text-center text-muted py-5" id="carrinhoVazioMsg">
                                        <i class="fa-solid fa-cart-arrow-down fa-2x mb-2 opacity-20"></i>
                                        <p>Carrinho vazio</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Payment -->
                            <div class="col-md-5 p-4 bg-dark bg-opacity-20">
                                <div class="mb-4">
                                    <label class="form-label small fw-bold">CLIENTE (OPCIONAL)</label>
                                    <select class="form-select" id="vendaCliente">
                                        <option value="">Selecione um cliente</option>
                                        <option th:each="cliente : ${clientes}" th:value="${cliente.id}"
                                            th:text="${cliente.nome}">Nome</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label small fw-bold mb-3">FORMA DE PAGAMENTO</label>
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check" th:each="forma : ${formasPagamento}">
                                            <input class="form-check-input" type="radio" name="formaPagamento"
                                                th:id="'fp-' + ${forma}" th:value="${forma}"
                                                th:checked="${forma.name() == 'DINHEIRO'}">
                                            <label class="form-check-label text-light" th:for="'fp-' + ${forma}"
                                                th:text="${forma.descricao}">Dinheiro</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-5 pt-3 border-top border-secondary border-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-secondary small fw-bold">TOTAL</span>
                                        <span class="fs-3 fw-bold text-white" id="vendaTotal">R$ 0,00</span>
                                    </div>
                                    <button type="button" class="btn btn-success w-100 fw-bold py-3 shadow-lg"
                                        id="btnConfirmarVenda" disabled>
                                        <i class="fa-solid fa-check me-2"></i> FINALIZAR VENDA
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSRF -->
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"
            id="csrfToken" />

        <!-- Scripts -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            document.addEventListener('DOMContentLoaded', function () {
                // Modals
                const modalProduto = new bootstrap.Modal(document.getElementById('modalNovoProduto'));
                const modalVenda = new bootstrap.Modal(document.getElementById('modalFinalizarVenda'));

                // State
                let carrinho = [];

                // --- Currency Mask ---
                const formatMoeda = (val) => {
                    if (!val) return '0,00';
                    return parseFloat(val).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                };

                const applyMask = (input, hidden) => {
                    let val = input.value.replace(/\D/g, '');
                    if (!val) {
                        input.value = '';
                        hidden.value = '';
                        return;
                    }
                    const decimal = parseInt(val) / 100;
                    input.value = formatMoeda(decimal);
                    hidden.value = decimal.toFixed(2);
                };

                document.querySelectorAll('.currency-mask').forEach(input => {
                    input.addEventListener('input', function () {
                        const targetId = this.id.replace('Display', '');
                        const hidden = document.getElementById(targetId);
                        applyMask(this, hidden);
                    });
                });

                // --- New Product ---
                document.getElementById('btnNovoProduto').addEventListener('click', () => {
                    document.querySelector('form[method="post"]').reset();
                    document.getElementById('produtoId').value = '';
                    document.getElementById('modalTituloProduto').innerText = 'Novo Produto';
                    document.getElementById('btnSubmitProduto').innerText = 'CADASTRAR PRODUTO';
                });

                // --- Edit Product ---
                document.querySelectorAll('.btn-edit-produto').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const d = this.dataset;
                        document.getElementById('produtoId').value = d.id;
                        document.querySelector('[name="nome"]').value = d.nome;
                        document.querySelector('[name="descricao"]').value = d.descricao !== 'null' ? d.descricao : '';
                        document.getElementById('precoVenda').value = d.precoVenda;
                        document.getElementById('precoVendaDisplay').value = formatMoeda(d.precoVenda);
                        document.getElementById('precoCusto').value = d.precoCusto !== 'null' ? d.precoCusto : '';
                        document.getElementById('precoCustoDisplay').value = d.precoCusto !== 'null' ? formatMoeda(d.precoCusto) : '';
                        document.querySelector('[name="estoque"]').value = d.estoque !== 'null' ? d.estoque : '';
                        document.querySelector('[name="estoqueMinimo"]').value = d.estoqueMinimo !== 'null' ? d.estoqueMinimo : '';
                        document.querySelector('[name="categoria"]').value = d.categoria;
                        document.querySelector('[name="unidade"]').value = d.unidade;
                        document.querySelector('[name="ean"]').value = d.ean !== 'null' ? d.ean : '';

                        document.getElementById('modalTituloProduto').innerText = 'Editar Produto';
                        document.getElementById('btnSubmitProduto').innerText = 'SALVAR ALTERAÇÕES';
                        modalProduto.show();
                    });
                });

                // --- Cart Logic ---
                const updateCartUI = (animate = false) => {
                    const badge = document.getElementById('badgeCarrinho');
                    const totalQtd = carrinho.reduce((acc, it) => acc + it.qtd, 0);
                    badge.innerText = totalQtd;

                    if (animate) {
                        badge.classList.remove('badge-animate');
                        void badge.offsetWidth; // Trigger reflow
                        badge.classList.add('badge-animate');
                    }

                    const list = document.getElementById('listaItensVenda');
                    const empty = document.getElementById('carrinhoVazioMsg') || (() => {
                        const el = document.createElement('div');
                        el.id = 'carrinhoVazioMsg';
                        el.className = 'text-center text-muted py-5';
                        el.innerHTML = '<i class="fa-solid fa-cart-arrow-down fa-2x mb-2 opacity-20"></i><p>Carrinho vazio</p>';
                        return el;
                    })();
                    const confirmBtn = document.getElementById('btnConfirmarVenda');

                    if (carrinho.length === 0) {
                        list.innerHTML = '';
                        list.appendChild(empty);
                        confirmBtn.disabled = true;
                        document.getElementById('vendaTotal').innerText = 'R$ 0,00';
                        return;
                    }

                    if (empty && empty.parentElement) empty.remove();
                    list.innerHTML = '';
                    confirmBtn.disabled = false;
                    let total = 0;

                    carrinho.forEach((it, idx) => {
                        const sub = it.qtd * it.preco;
                        total += sub;
                        const div = document.createElement('div');
                        div.className = 'd-flex justify-content-between align-items-center bg-dark bg-opacity-40 p-3 rounded-3 border border-secondary border-opacity-10';
                        div.innerHTML = `
                            <div class="d-flex flex-column">
                                <span class="text-white fw-bold small">${it.nome}</span>
                                <span class="text-secondary small" style="font-size: 11px;">${it.qtd}x R$ ${formatMoeda(it.preco)}</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-info fw-bold">R$ ${formatMoeda(sub)}</span>
                                <button class="btn btn-sm text-danger border-0 p-1" onclick="window.removeCartItem(${idx})">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                    document.getElementById('vendaTotal').innerText = 'R$ ' + formatMoeda(total);
                };

                window.removeCartItem = (idx) => {
                    carrinho.splice(idx, 1);
                    updateCartUI();
                };

                window.showToast = (message) => {
                    let container = document.getElementById('toast-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'toast-container';
                        container.style.cssText = 'position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end;';
                        document.body.appendChild(container);
                    }

                    const toast = document.createElement('div');
                    toast.className = 'custom-toast';
                    toast.style.position = 'static';
                    toast.innerHTML = `<i class="fa-solid fa-cart-check text-info"></i> <span>${message}</span>`;
                    container.appendChild(toast);

                    requestAnimationFrame(() => {
                        toast.classList.add('show');
                    });

                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 2500);
                };

                document.querySelectorAll('.btn-add-carrinho').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const d = this.dataset;
                        const estoque = parseInt(d.estoque || '0', 10);
                        const exist = carrinho.find(it => it.id === d.id);
                        if (exist) {
                            if (exist.qtd >= estoque) {
                                window.showToast(`Estoque insuficiente para ${d.nome}`);
                                return;
                            }
                            exist.qtd++;
                        } else {
                            if (estoque <= 0) {
                                window.showToast(`Estoque insuficiente para ${d.nome}`);
                                return;
                            }
                            carrinho.push({ id: d.id, nome: d.nome, preco: parseFloat(d.preco), qtd: 1 });
                        }
                        updateCartUI(true);
                        window.showToast(`${d.nome} adicionado!`);

                        // Feedback Icon
                        const icon = this.querySelector('i');
                        const orig = icon.className;
                        icon.className = 'fa-solid fa-check text-success';

                        if (this._timeout) clearTimeout(this._timeout);
                        this._timeout = setTimeout(() => icon.className = orig, 800);
                    });
                });

                // --- Finalize Sale ---
                document.getElementById('btnConfirmarVenda').addEventListener('click', async function () {
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processando...';

                    const payload = {
                        clienteId: document.getElementById('vendaCliente').value || null,
                        formaPagamento: document.querySelector('input[name="formaPagamento"]:checked').value,
                        itens: carrinho.map(it => ({
                            produtoId: parseInt(it.id),
                            quantidade: it.qtd,
                            precoUnitario: it.preco
                        }))
                    };

                    try {
                        const csrfToken = document.getElementById('csrfToken')?.value;
                        const response = await fetch('/vendas/salvar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            Swal.fire({
                                title: 'Venda Concluída!',
                                text: 'O estoque foi atualizado com sucesso.',
                                icon: 'success',
                                background: '#0f1623',
                                color: '#fff'
                            }).then(() => window.location.reload());
                        } else {
                            throw new Error();
                        }
                    } catch (e) {
                        Swal.fire({ title: 'Erro!', text: 'Falha ao processar venda.', icon: 'error' });
                        this.disabled = false;
                        this.innerHTML = '<i class="fa-solid fa-check me-2"></i> FINALIZAR VENDA';
                    }
                });

                // --- Flash Messages ---
                const msg = /*[[${produtoSucesso}]]*/ null;
                const pNome = /*[[${produtoNome}]]*/ null;
                const pEstoque = /*[[${produtoEstoque}]]*/ null;
                if (msg === 'cadastrado' || msg === 'atualizado') {
                    Swal.fire({ title: 'Sucesso!', text: `Produto ${pNome} ${msg} com sucesso.`, icon: 'success', background: '#0f1623', color: '#fff' });
                } else if (msg === 'estoque_incrementado') {
                    Swal.fire({ title: 'Estoque Atualizado!', text: `${pNome} agora possui ${pEstoque} em estoque.`, icon: 'success', background: '#0f1623', color: '#fff' });
                }
                
                const scanNovo = /*[[${produtoScanNovo}]]*/ false;
                const scanEan = /*[[${produtoEan}]]*/ null;
                if (scanNovo) {
                    document.querySelector('form[method="post"]').reset();
                    document.getElementById('produtoId').value = '';
                    document.getElementById('modalTituloProduto').innerText = 'Novo Produto';
                    document.getElementById('btnSubmitProduto').innerText = 'CADASTRAR PRODUTO';
                    if (scanEan) document.querySelector('[name="ean"]').value = scanEan;
                    modalProduto.show();
                }
            });
            /*]]>*/
        </script>
    </div>
</body>

</html>
