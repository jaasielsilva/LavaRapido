<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::div})}">
<body>
    <div>
        <!-- Header -->
        <header>
                <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Produtos</h1>
                    <div class="subtitle">Gerencie seu estoque e vendas</div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary position-relative" id="btnAbrirVenda" data-bs-toggle="modal" data-bs-target="#modalFinalizarVenda">
                        <i class="fa-solid fa-cart-shopping me-2"></i> Vender
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info" id="badgeCarrinho">
                            0
                        </span>
                    </button>
                    <button class="btn btn-primary" id="btnNovoProduto" data-bs-toggle="modal" data-bs-target="#modalNovoProduto">
                        <i class="fa-solid fa-plus me-2"></i> Novo Produto
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="cards mb-4">
            <div class="card blue">
                <div class="card-info">
                    <h4>Total Produtos</h4>
                    <span class="number" th:text="${totalProdutos}">0</span>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-box"></i>
                </div>
            </div>

            <div class="card orange">
                <div class="card-info">
                    <h4>Estoque Baixo</h4>
                    <span class="number" th:text="${estoqueBaixo}">0</span>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
            </div>

            <div class="card green">
                <div class="card-info">
                    <h4>Valor em Estoque</h4>
                    <span class="number" th:text="'R$ ' + ${#numbers.formatDecimal(valorEstoque != null ? valorEstoque : 0, 0, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                </div>
                <div class="icon-box">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="d-flex justify-content-between mb-4">
            <div class="search-bar flex-grow-1 me-3">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Buscar produtos...">
            </div>
            <select class="form-select bg-dark text-secondary border-secondary w-auto" style="min-width: 200px;">
                <option selected>Todas Categorias</option>
                <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat.descricao}">Categoria</option>
            </select>
        </div>

        <!-- Tabela de Produtos -->
        <div class="card d-block w-100 border border-secondary border-opacity-10 bg-dark-subtle overflow-hidden" style="background-color: #0b121f !important;">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="--bs-table-bg: transparent; --bs-table-hover-bg: rgba(255,255,255,0.03);">
                    <thead style="background-color: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <tr>
                            <th scope="col" class="py-4 ps-4 text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">Produto</th>
                            <th scope="col" class="py-4 text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">Categoria</th>
                            <th scope="col" class="py-4 text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">Preço</th>
                            <th scope="col" class="py-4 text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">Estoque</th>
                            <th scope="col" class="py-4 text-end pe-4 text-secondary text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        <tr th:if="${produtos.empty}">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <div class="py-4">
                                    <div class="mb-3 d-inline-flex align-items-center justify-content-center rounded-circle bg-dark border border-secondary border-opacity-25" style="width: 64px; height: 64px;">
                                        <i class="fa-solid fa-box-open fa-lg text-secondary"></i>
                                    </div>
                                    <h6 class="text-white mb-1">Nenhum produto encontrado</h6>
                                    <p class="text-secondary small mb-0">Comece adicionando itens ao seu estoque.</p>
                                </div>
                            </td>
                        </tr>
                        <tr th:each="produto : ${produtos}" style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                            <td class="ps-4 py-3">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-3 d-flex align-items-center justify-content-center me-3 shadow-sm" 
                                         style="width: 42px; height: 42px; background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.05);">
                                        <i class="fa-solid fa-box text-info opacity-75"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-white mb-1" th:text="${produto.nome}" style="font-size: 0.95rem;">Nome</div>
                                        <div class="small text-secondary text-truncate" style="max-width: 250px; font-size: 0.8rem;" th:text="${produto.descricao}">Descrição</div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3">
                                <span class="badge rounded-pill border border-opacity-10 fw-semibold px-3 py-2" 
                                      th:classappend="'bg-soft-' + ${produto.categoria.cor}"
                                      style="font-size: 0.7rem; letter-spacing: 0.5px;"
                                      th:text="${produto.categoria.descricao}">Categoria</span>
                            </td>
                            <td class="py-3">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold text-white" th:text="'R$ ' + ${#numbers.formatDecimal(produto.precoVenda != null ? produto.precoVenda : 0, 0, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                                    <span class="text-secondary opacity-50" style="font-size: 0.75rem;" th:if="${produto.precoCusto != null}" th:text="'Custo: R$ ' + ${#numbers.formatDecimal(produto.precoCusto, 0, 'POINT', 2, 'COMMA')}"></span>
                                </div>
                            </td>
                            <td class="py-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="fw-bold text-white" th:text="${produto.estoque}">0</div>
                                        <div class="text-secondary" style="font-size: 0.7rem;" th:text="${produto.unidade.sigla}">UN</div>
                                    </div>
                                    <span class="badge bg-soft-warning border border-warning border-opacity-25 text-warning rounded-pill px-2 py-1" 
                                          th:if="${produto.estoque <= produto.estoqueMinimo}"
                                          style="font-size: 0.65rem;">
                                        <i class="fa-solid fa-triangle-exclamation me-1"></i> BAIXO
                                    </span>
                                </div>
                            </td>
                            <td class="text-end pe-4 py-3">
                                <div class="d-flex justify-content-end gap-2">
                                    <!-- Botão Adicionar ao Carrinho -->
                                    <button class="btn btn-icon btn-ghost-info btn-add-carrinho rounded-2"
                                            title="Adicionar ao Carrinho"
                                            th:data-id="${produto.id}"
                                            th:data-nome="${produto.nome}"
                                            th:data-preco="${produto.precoVenda}"
                                            style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(14, 165, 233, 0.2); background: rgba(14, 165, 233, 0.05);">
                                        <i class="fa-solid fa-cart-plus text-info" style="font-size: 0.9rem;"></i>
                                        <input type="hidden" class="input-qtd" value="1">
                                    </button>
                                    
                                    <!-- Botão Editar -->
                                    <button class="btn btn-icon btn-ghost-secondary btn-edit-produto rounded-2"
                                       title="Editar"
                                       th:data-id="${produto.id}"
                                       th:data-nome="${produto.nome}"
                                       th:data-descricao="${produto.descricao}"
                                       th:data-preco-venda="${produto.precoVenda}"
                                       th:data-preco-custo="${produto.precoCusto}"
                                       th:data-estoque="${produto.estoque}"
                                       th:data-estoque-minimo="${produto.estoqueMinimo}"
                                       th:data-categoria="${produto.categoria}"
                                       th:data-unidade="${produto.unidade}"
                                       style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(148, 163, 184, 0.05);">
                                        <i class="fa-solid fa-pen text-secondary" style="font-size: 0.9rem;"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Finalizar Venda -->
        <div class="modal fade" id="modalFinalizarVenda" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-bottom border-secondary border-opacity-10">
                        <h5 class="modal-title fw-bold">Finalizar Venda</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-4">
                            <!-- Coluna Esquerda: Itens -->
                            <div class="col-md-8 border-end border-secondary border-opacity-10">
                                <h6 class="text-info mb-3"><i class="fa-solid fa-list me-2"></i>Itens do Pedido</h6>
                                
                                <div id="listaItensVenda" class="d-flex flex-column gap-2 mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Itens serão injetados aqui via JS -->
                                    <div class="text-center text-muted py-5" id="carrinhoVazioMsg">
                                        <i class="fa-solid fa-cart-arrow-down fa-2x mb-2"></i>
                                        <p>Carrinho vazio</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna Direita: Pagamento e Total -->
                            <div class="col-md-4 d-flex flex-column">
                                <h6 class="text-info mb-3"><i class="fa-solid fa-user me-2"></i>Cliente (Opcional)</h6>
                                <select class="form-select bg-dark text-light border-secondary focus-info mb-4" id="vendaCliente">
                                    <option value="" selected>Selecione um cliente</option>
                                    <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nome}">João</option>
                                </select>

                                <h6 class="text-info mb-3"><i class="fa-solid fa-money-bill-wave me-2"></i>Forma de Pagamento</h6>
                                <div class="d-flex flex-column gap-2 mb-4">
                                    <div class="form-check" th:each="forma : ${formasPagamento}">
                                        <input class="form-check-input bg-dark border-secondary" type="radio" name="formaPagamento" th:id="${forma}" th:value="${forma}" th:checked="${forma.name() == 'DINHEIRO'}">
                                        <label class="form-check-label text-light" th:for="${forma}" th:text="${forma.descricao}">
                                            Dinheiro
                                        </label>
                                    </div>
                                </div>

                                <div class="mt-auto pt-3 border-top border-secondary border-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-secondary">Total:</span>
                                        <span class="fs-3 fw-bold text-white" id="vendaTotal">R$ 0,00</span>
                                    </div>
                                    <button type="button" class="btn btn-success w-100 fw-bold py-2" id="btnFinalizarVenda" disabled>
                                        <i class="fa-solid fa-check me-2"></i> Finalizar Venda
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Novo Produto -->
        <div class="modal fade" id="modalNovoProduto" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-bottom border-secondary border-opacity-10">
                        <h5 class="modal-title fw-bold" id="modalTituloProduto">Novo Produto</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form th:action="@{/produtos/salvar}" method="post" th:object="${novoProduto}">
                        <div class="modal-body">
                            
                            <input type="hidden" th:field="*{id}" id="produtoId" />
                            
                            <div class="mb-3">
                                <label for="nome" class="form-label text-light small fw-bold">Nome *</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary focus-info" id="nome" th:field="*{nome}" placeholder="Nome do produto" required>
                            </div>

                            <div class="mb-3">
                                <label for="descricao" class="form-label text-light small fw-bold">Descrição</label>
                                <textarea class="form-control bg-dark text-light border-secondary focus-info" id="descricao" th:field="*{descricao}" placeholder="Descrição" rows="2"></textarea>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="precoVenda" class="form-label text-light small fw-bold">Preço de Venda *</label>
                                    <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary focus-info" id="precoVenda" th:field="*{precoVenda}" placeholder="0" required>
                                </div>
                                <div class="col-6">
                                    <label for="precoCusto" class="form-label text-light small fw-bold">Preço de Custo</label>
                                    <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary focus-info" id="precoCusto" th:field="*{precoCusto}" placeholder="0">
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="estoque" class="form-label text-light small fw-bold">Estoque</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary focus-info" id="estoque" th:field="*{estoque}" placeholder="0">
                                </div>
                                <div class="col-6">
                                    <label for="estoqueMinimo" class="form-label text-light small fw-bold">Estoque Mínimo</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary focus-info" id="estoqueMinimo" th:field="*{estoqueMinimo}" value="5">
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-6">
                                    <label for="categoria" class="form-label text-light small fw-bold">Categoria</label>
                                    <select class="form-select bg-dark text-light border-secondary focus-info" id="categoria" th:field="*{categoria}">
                                        <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat.descricao}">Outros</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="unidade" class="form-label text-light small fw-bold">Unidade</label>
                                    <select class="form-select bg-dark text-light border-secondary focus-info" id="unidade" th:field="*{unidade}">
                                        <option th:each="un : ${unidades}" th:value="${un}" th:text="${un.descricao}">Unidade</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer border-top-0 pt-0">
                            <button type="submit" class="btn btn-info w-100 fw-bold" id="btnSubmitProduto">Cadastrar Produto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Estado do Carrinho
                let carrinho = [];

                // Seletores
                const badgeCarrinho = document.getElementById('badgeCarrinho');
                const btnAbrirVenda = document.getElementById('btnAbrirVenda');
                const listaItensVenda = document.getElementById('listaItensVenda');
                const carrinhoVazioMsg = document.getElementById('carrinhoVazioMsg');
                const vendaTotal = document.getElementById('vendaTotal');
                const btnFinalizarVenda = document.getElementById('btnFinalizarVenda');
                
                const modalNovoProdutoEl = document.getElementById('modalNovoProduto');
                const modalNovoProduto = modalNovoProdutoEl ? new bootstrap.Modal(modalNovoProdutoEl) : null;
                const btnNovoProduto = document.getElementById('btnNovoProduto');
                const modalTituloProduto = document.getElementById('modalTituloProduto');
                const btnSubmitProduto = document.getElementById('btnSubmitProduto');
                const inputId = document.getElementById('produtoId');
                const inputNome = document.getElementById('nome');
                const inputDescricao = document.getElementById('descricao');
                const inputPrecoVenda = document.getElementById('precoVenda');
                const inputPrecoCusto = document.getElementById('precoCusto');
                const inputEstoque = document.getElementById('estoque');
                const inputEstoqueMinimo = document.getElementById('estoqueMinimo');
                const selectCategoria = document.getElementById('categoria');
                const selectUnidade = document.getElementById('unidade');

                if (btnNovoProduto) {
                    btnNovoProduto.addEventListener('click', function() {
                        if (inputId) inputId.value = '';
                        if (inputNome) inputNome.value = '';
                        if (inputDescricao) inputDescricao.value = '';
                        if (inputPrecoVenda) inputPrecoVenda.value = '';
                        if (inputPrecoCusto) inputPrecoCusto.value = '';
                        if (inputEstoque) inputEstoque.value = '';
                        if (inputEstoqueMinimo) inputEstoqueMinimo.value = inputEstoqueMinimo.getAttribute('value') || '';
                        if (selectCategoria) selectCategoria.selectedIndex = 0;
                        if (selectUnidade) selectUnidade.selectedIndex = 0;
                        if (modalTituloProduto) modalTituloProduto.textContent = 'Novo Produto';
                        if (btnSubmitProduto) btnSubmitProduto.textContent = 'Cadastrar Produto';
                    });
                }

                document.querySelectorAll('.btn-edit-produto').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const data = this.dataset;

                        if (inputId) inputId.value = data.id || '';
                        if (inputNome) inputNome.value = data.nome || '';
                        if (inputDescricao) inputDescricao.value = data.descricao && data.descricao !== 'null' ? data.descricao : '';
                        if (inputPrecoVenda) inputPrecoVenda.value = data.precoVenda || '';
                        if (inputPrecoCusto) inputPrecoCusto.value = data.precoCusto && data.precoCusto !== 'null' ? data.precoCusto : '';
                        if (inputEstoque) inputEstoque.value = data.estoque && data.estoque !== 'null' ? data.estoque : '';
                        if (inputEstoqueMinimo) inputEstoqueMinimo.value = data.estoqueMinimo && data.estoqueMinimo !== 'null' ? data.estoqueMinimo : '';
                        if (selectCategoria && data.categoria) selectCategoria.value = data.categoria;
                        if (selectUnidade && data.unidade) selectUnidade.value = data.unidade;

                        if (modalTituloProduto) modalTituloProduto.textContent = 'Editar Produto';
                        if (btnSubmitProduto) btnSubmitProduto.textContent = 'Salvar Alterações';

                        if (modalNovoProduto) modalNovoProduto.show();
                    });
                });

                // --- Lógica de Quantidade no Card ---
                document.querySelectorAll('.btn-qtd-menos').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const input = this.parentElement.querySelector('.input-qtd');
                        let val = parseInt(input.value);
                        if (val > 1) input.value = val - 1;
                    });
                });

                document.querySelectorAll('.btn-qtd-mais').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const input = this.parentElement.querySelector('.input-qtd');
                        input.value = parseInt(input.value) + 1;
                    });
                });

                // --- Adicionar ao Carrinho ---
                document.querySelectorAll('.btn-add-carrinho').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.dataset.id;
                        const nome = this.dataset.nome;
                        const preco = parseFloat(this.dataset.preco);
                        
                        // Default to 1 if input not found (for table view)
                        const qtdInput = this.querySelector('.input-qtd');
                        const quantidade = qtdInput ? parseInt(qtdInput.value) : 1;

                        // Verificar se já existe
                        const itemExistente = carrinho.find(item => item.id === id);
                        if (itemExistente) {
                            itemExistente.quantidade += quantidade;
                        } else {
                            carrinho.push({ id, nome, preco, quantidade });
                        }

                        atualizarUI();
                        
                        // Feedback visual (Toast ou SweetAlert seria melhor, mas aqui simples)
                        const originalHtml = this.innerHTML;
                        const icon = this.querySelector('i');
                        if(icon) {
                            icon.className = 'fa-solid fa-check text-success';
                            setTimeout(() => {
                                icon.className = 'fa-solid fa-cart-plus';
                            }, 1000);
                        }
                    });
                });

                // --- Renderizar Modal de Venda ---
                function atualizarUI() {
                    // Badge
                    const totalItens = carrinho.reduce((acc, item) => acc + item.quantidade, 0);
                    badgeCarrinho.textContent = totalItens;

                    // Lista no Modal
                    listaItensVenda.innerHTML = '';
                    if (carrinho.length === 0) {
                        listaItensVenda.appendChild(carrinhoVazioMsg);
                        carrinhoVazioMsg.style.display = 'block';
                        btnFinalizarVenda.disabled = true;
                        vendaTotal.textContent = 'R$ 0,00';
                        return;
                    }
                    
                    carrinhoVazioMsg.style.display = 'none';
                    let totalValor = 0;

                    carrinho.forEach((item, index) => {
                        const subtotal = item.quantidade * item.preco;
                        totalValor += subtotal;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'd-flex justify-content-between align-items-center bg-dark border border-secondary border-opacity-10 p-2 rounded';
                        itemDiv.innerHTML = `
                            <div class="d-flex flex-column">
                                <span class="text-white fw-bold small">${item.nome}</span>
                                <span class="text-secondary" style="font-size: 11px;">${item.quantidade}x R$ ${item.preco.toFixed(2)}</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-info fw-bold small">R$ ${subtotal.toFixed(2)}</span>
                                <button class="btn btn-sm btn-outline-danger border-0 p-1 btn-remover-item" data-index="${index}">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        `;
                        listaItensVenda.appendChild(itemDiv);
                    });

                    vendaTotal.textContent = 'R$ ' + totalValor.toFixed(2).replace('.', ',');
                    btnFinalizarVenda.disabled = false;

                    // Re-attach listeners de remover
                    document.querySelectorAll('.btn-remover-item').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const idx = parseInt(this.dataset.index);
                            carrinho.splice(idx, 1);
                            atualizarUI();
                        });
                    });
                }

                // --- Finalizar Venda ---
                btnFinalizarVenda.addEventListener('click', function() {
                    const clienteId = document.getElementById('vendaCliente').value;
                    const formaPagamento = document.querySelector('input[name="formaPagamento"]:checked').value;

                    const vendaDTO = {
                        clienteId: clienteId ? parseInt(clienteId) : null,
                        formaPagamento: formaPagamento,
                        itens: carrinho.map(item => ({
                            produtoId: parseInt(item.id),
                            quantidade: item.quantidade,
                            precoUnitario: item.preco
                        }))
                    };
                    
                    // Enviar para o backend
                    fetch('/vendas/salvar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
                        },
                        body: JSON.stringify(vendaDTO)
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        }
                        throw new Error('Erro na requisição');
                    })
                    .then(msg => {
                        // Sucesso
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalFinalizarVenda'));
                        modal.hide();
                        
                        Swal.fire({
                            title: 'Sucesso!',
                            text: 'Venda realizada com sucesso.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.reload(); // Recarregar para atualizar estoque
                        });
                        
                        carrinho = [];
                        atualizarUI();
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Erro!',
                            text: 'Não foi possível finalizar a venda.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
                });
            });
        </script>
        
        <script th:inline="javascript">
        /*<![CDATA[*/
            const produtoSucesso = [[${produtoSucesso}]];
            const produtoNome = [[${produtoNome}]];
            if (produtoSucesso) {
                document.addEventListener('DOMContentLoaded', function() {
                    let mensagem;
                    if (produtoSucesso === 'cadastrado') {
                        mensagem = 'Produto ' + (produtoNome || '') + ' cadastrado com sucesso.';
                    } else {
                        mensagem = 'Produto ' + (produtoNome || '') + ' atualizado com sucesso.';
                    }
                    Swal.fire({
                        title: 'Sucesso!',
                        text: mensagem,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                });
            }
        /*]]>*/
        </script>
        
        <!-- CSRF Token Hidden Input (necessário para o fetch funcionar com Spring Security) -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <style>
            /* Card Styling Premium */
            .service-card {
                background-color: #0f1623;
                border: 1px solid #1e293b;
                border-radius: 12px;
                transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.2s ease;
            }

            .service-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                border-color: #0284c7;
            }

            /* Badge Colors (Soft) */
            .bg-soft-info { background: rgba(14, 165, 233, 0.15); color: #38bdf8; }
            .bg-soft-warning { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
            .bg-soft-success { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
            .bg-soft-secondary { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
            .bg-soft-primary { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
            .bg-soft-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; }

            .focus-info:focus {
                border-color: #0ea5e9 !important;
                box-shadow: 0 0 0 0.25rem rgba(14, 165, 233, 0.25) !important;
            }
            .btn-info {
                background-color: #0ea5e9;
                border-color: #0ea5e9;
                color: white;
            }
            .btn-info:hover {
                background-color: #0284c7;
                border-color: #0284c7;
            }
            .text-info {
                color: #38bdf8 !important;
            }

            /* Dark Theme Form Styles */
            .modal-content {
                background: #1e293b;
                border: 1px solid #475569;
            }
            .modal-header {
                border-bottom: 1px solid #334155;
            }
            .form-label {
                color: #94a3b8;
            }
            .form-control, .form-select {
                background: #0f1623;
                border: 1px solid #334155;
                color: white;
            }
            .form-control:focus, .form-select:focus {
                background: #0f1623;
                border-color: #3b82f6;
                color: white;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            }
            .btn-close-white {
                filter: invert(1) grayscale(100%) brightness(200%);
            }
            .btn-primary-custom {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border: none;
            }
            .btn-primary-custom:hover {
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
                color: white;
            }
            .btn-secondary-custom {
                background: rgba(255, 255, 255, 0.05);
                color: #94a3b8;
                border: 1px solid #334155;
            }
            .btn-secondary-custom:hover {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
        </style>
        
        <!-- Mask Script -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Currency Mask Logic
                const moneyInputs = document.querySelectorAll('.money-mask');
                
                moneyInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value === '') {
                            e.target.value = '';
                            return;
                        }
                        value = (parseInt(value) / 100).toFixed(2) + '';
                        value = value.replace('.', ',');
                        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                        e.target.value = 'R$ ' + value;
                    });
                    
                    // Format on load if value exists
                    if (input.value) {
                        let val = parseFloat(input.value);
                        if (!isNaN(val)) {
                             let formatted = val.toFixed(2).replace('.', ',');
                             formatted = formatted.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                             input.value = 'R$ ' + formatted;
                        }
                    }
                });

                // Unmask before submit
                const form = document.getElementById('formProduto');
                if (form) {
                    form.addEventListener('submit', function() {
                        moneyInputs.forEach(input => {
                            let val = input.value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                            input.value = val;
                        });
                    });
                }
            });
        </script>
    </div>
</body>
</html>
