<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::div})}">
<body>
    <div>
        <header>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Clientes</h1>
                    <div class="subtitle">Gerencie seus clientes e veículos</div>
                </div>
                <a th:href="@{/clientes/novo}" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i> Novo Cliente
                </a>
            </div>
            
            <div class="search-bar mb-4">
                <div class="d-flex w-100 align-items-center position-relative">
                    <i class="fa-solid fa-magnifying-glass me-2 text-secondary"></i>
                    <input type="text" id="inputBusca" class="bg-transparent border-0 text-white w-100" 
                           style="outline: none;" placeholder="Buscar por nome, telefone ou placa..."
                           th:value="${busca}" autocomplete="off">
                    <div id="loadingSearch" class="spinner-border text-primary spinner-border-sm position-absolute end-0 me-2 d-none" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="clientesWrapper">
            <div id="clientesContainer" th:fragment="listaClientes">
                <div th:if="${clientes.empty}" class="text-center py-5">
                    <i class="fa-solid fa-users-slash fa-3x mb-3 text-muted"></i>
                    <h4 class="text-muted">Nenhum cliente encontrado</h4>
                    <p class="text-secondary mb-4">Tente buscar com outros termos ou cadastre um novo.</p>
                </div>

        <div th:if="${!clientes.empty}" class="client-list">
            <div th:each="cliente : ${clientes}" class="client-card">
                <div class="client-header">
                    <div class="client-info">
                        <h3 th:text="${cliente.nome}">Nome do Cliente</h3>
                        <div class="client-contact">
                            <span><i class="fa-solid fa-phone"></i> <span th:text="${cliente.telefone}">Telefone</span></span>
                            <span th:if="${cliente.email}"><i class="fa-solid fa-envelope"></i> <span th:text="${cliente.email}">Email</span></span>
                        </div>
                    </div>
                    <div class="client-meta">
                        Cliente desde <span th:text="${#temporals.format(cliente.dataCadastro, 'dd/MM/yyyy')}">Data</span>
                        <div class="d-flex justify-content-end mt-2 gap-2">
                            <a th:href="@{/clientes/editar/{id}(id=${cliente.id})}"
                               class="btn btn-sm btn-outline-light"
                               title="Editar cliente">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Excluir"
                                    th:onclick="'confirmarExclusaoCliente(' + ${cliente.id} + ')'"
                                    sec:authorize="hasAnyRole('MASTER','ADMIN')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="client-vehicles-section">
                    <div class="section-label">Veículos</div>
                    <div class="vehicles-grid">
                        <div th:each="veiculo : ${cliente.veiculos}" class="vehicle-card">
                            <div class="vehicle-icon">
                                <i class="fa-solid fa-car"></i>
                            </div>
                            <div class="vehicle-details">
                                <strong th:text="${veiculo.modelo}">Modelo</strong>
                                <div class="vehicle-sub">
                                    <span th:text="${veiculo.placa}">ABC-1234</span> • 
                                    <span th:text="${veiculo.cor != null ? veiculo.cor : 'Cor'}">Cor</span> • 
                                    <span th:text="${veiculo.ano != null ? veiculo.ano : 'Ano'}">Ano</span>
                                </div>
                            </div>
                        </div>

                        <a href="#"
                           class="btn-add-vehicle"
                           th:attr="data-cliente-id=${cliente.id}"
                           data-bs-toggle="modal"
                           data-bs-target="#modalAdicionarVeiculo">
                            <i class="fa-solid fa-plus"></i> Adicionar Veículo
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <nav th:if="${!clientes.empty and clientesPage != null and clientesPage.totalPages > 1}" aria-label="Navegação de páginas">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${clientesPage.first} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/clientes(page=${clientesPage.number - 1},size=${clientesPage.size},busca=${busca})}"
                       aria-label="Anterior">
                        <i class="fa-solid fa-chevron-left"></i> Anterior
                    </a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link"
                          th:text="'Página ' + (${clientesPage.number + 1}) + ' de ' + ${clientesPage.totalPages}">1 de 1</span>
                </li>
                <li class="page-item" th:classappend="${clientesPage.last} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/clientes(page=${clientesPage.number + 1},size=${clientesPage.size},busca=${busca})}"
                       aria-label="Próxima">
                        Próxima <i class="fa-solid fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

        <div class="modal fade" id="modalAdicionarVeiculo" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar Veículo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form th:action="@{/veiculos/salvar}" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="cliente.id" id="modalClienteId">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                            <div class="mb-3">
                                <label for="placa" class="form-label">Placa</label>
                                <input type="text" class="form-control" id="placa" name="placa" required>
                            </div>

                            <div class="mb-3">
                                <label for="modelo" class="form-label">Modelo</label>
                                <input type="text" class="form-control" id="modelo" name="modelo" required>
                            </div>

                            <div class="mb-3">
                                <label for="cor" class="form-label">Cor</label>
                                <input type="text" class="form-control" id="cor" name="cor">
                            </div>

                            <div class="mb-3">
                                <label for="ano" class="form-label">Ano</label>
                                <input type="number" class="form-control" id="ano" name="ano">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script th:inline="javascript">
        /*<![CDATA[*/
            document.addEventListener("DOMContentLoaded", function () {
                var modalElement = document.getElementById("modalAdicionarVeiculo");
                var modalClienteIdInput = document.getElementById("modalClienteId");
                var form = modalElement.querySelector("form");

                document.querySelectorAll(".btn-add-vehicle").forEach(function (btn) {
                    btn.addEventListener("click", function () {
                        var clienteId = this.getAttribute("data-cliente-id");
                        form.reset();
                        modalClienteIdInput.value = clienteId;
                    });
                });

                form.addEventListener("submit", function (e) {
                    e.preventDefault();
                    var formData = new FormData(form);
                    fetch(form.action, {
                        method: form.method,
                        body: formData,
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    }).then(function (response) {
                        if (!response.ok) {
                            return response.text().then(function (message) {
                                throw new Error(message || "Ocorreu um erro ao salvar o veículo");
                            });
                        }
                        var instance = bootstrap.Modal.getInstance(modalElement);
                        if (!instance) {
                            instance = new bootstrap.Modal(modalElement);
                        }
                        instance.hide();
                        window.location.reload();
                    }).catch(function (error) {
                        Swal.fire({
                            title: 'Erro ao salvar veículo',
                            text: error.message || 'Ocorreu um erro ao salvar o veículo.',
                            icon: 'error',
                            confirmButtonText: 'Fechar'
                        });
                    });
                });

                var clienteSucesso = /*[[${clienteSucesso}]]*/ null;
                var clienteErro = /*[[${clienteErro}]]*/ null;

                if (clienteSucesso) {
                    var msgSucesso;
                    if (clienteSucesso === 'excluido') {
                        msgSucesso = 'Cliente excluído com sucesso.';
                    }
                    if (msgSucesso) {
                        Swal.fire({
                            title: 'Sucesso!',
                            text: msgSucesso,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    }
                }

                if (clienteErro) {
                    Swal.fire({
                        title: 'Atenção',
                        text: clienteErro,
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                }

                // Lógica de Busca Instantânea
                const inputBusca = document.getElementById('inputBusca');
                const loadingSearch = document.getElementById('loadingSearch');
                let debounceTimer;

                if (inputBusca) {
                    inputBusca.addEventListener('input', function() {
                        const termo = this.value;
                        
                        clearTimeout(debounceTimer);
                        loadingSearch.classList.remove('d-none');

                        debounceTimer = setTimeout(() => {
                            fetch(`/clientes?busca=${encodeURIComponent(termo)}&fragment=true`, {
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => response.text())
                            .then(html => {
                                const currentContainer = document.getElementById('clientesContainer');
                                if (currentContainer) {
                                    currentContainer.outerHTML = html;
                                }
                                loadingSearch.classList.add('d-none');
                            })
                            .catch(err => {
                                console.error('Erro na busca:', err);
                                loadingSearch.classList.add('d-none');
                            });
                        }, 400); // 400ms delay
                    });
                }
            });

            function confirmarExclusaoCliente(id) {
                Swal.fire({
                    title: 'Tem certeza?',
                    text: 'Você não poderá reverter isso!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sim, excluir!',
                    cancelButtonText: 'Cancelar',
                    background: '#0f1623',
                    color: '#fff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = `/clientes/excluir/${id}`;
                    }
                });
            }
        /*]]>*/
        </script>
    </div>
</body>
</html>
