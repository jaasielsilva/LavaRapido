<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout :: layout(~{::div})}">

<body>
    <div>
        <header>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Clientes</h1>
                    <div class="subtitle"
                        th:text="${cliente.id} == null ? 'Cadastro de novo cliente' : 'Edição de cliente'">
                        Cadastro de cliente
                    </div>
                </div>
                <a th:href="@{/clientes}" class="btn btn-secondary">
                    Voltar
                </a>
            </div>
        </header>

        <div class="box" style="max-width: 640px;">
            <div class="box-header">
                <h3 th:text="${cliente.id} == null ? 'Novo Cliente' : 'Editar Cliente'">Novo Cliente</h3>
            </div>

            <form th:action="@{/clientes/salvar}" th:object="${cliente}" method="post">
                <input type="hidden" th:field="*{id}" />

                <div class="mb-3" sec:authorize="hasRole('MASTER')">
                    <label for="empresa" class="form-label">Empresa</label>
                    <select id="empresa" class="form-select" th:field="*{empresa.id}" required>
                        <option value="" disabled th:selected="${cliente.empresa} == null">Selecione uma empresa
                        </option>
                        <option th:each="emp : ${empresas}" th:value="${emp.id}" th:text="${emp.nome}">
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="nome" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="nome" th:field="*{nome}" required>
                </div>

                <div class="mb-3">
                    <label for="telefone" class="form-label">Telefone</label>
                    <input type="tel" class="form-control" id="telefone" th:field="*{telefone}" inputmode="numeric" maxlength="15">
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="email" th:field="*{email}">
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/clientes}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var telefoneInput = document.getElementById('telefone');
            if (!telefoneInput) return;

            function aplicarMascaraTelefone(valor) {
                valor = valor.replace(/\D/g, '');
                if (valor.length > 11) valor = valor.slice(0, 11);
                if (valor.length > 10) {
                    return valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1)$2-$3');
                } else if (valor.length > 6) {
                    return valor.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1)$2-$3');
                } else if (valor.length > 2) {
                    return valor.replace(/(\d{2})(\d{0,5})/, '($1)$2');
                } else if (valor.length > 0) {
                    return valor.replace(/(\d{0,2})/, '($1');
                }
                return '';
            }

            function mascararEVincular() {
                telefoneInput.value = aplicarMascaraTelefone(telefoneInput.value);
            }

            telefoneInput.addEventListener('input', mascararEVincular);
            telefoneInput.addEventListener('change', mascararEVincular);
            telefoneInput.addEventListener('blur', mascararEVincular);

            telefoneInput.addEventListener('keypress', function (e) {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });

            // Aplica máscara ao carregar valor já existente (sempre)
            mascararEVincular();
        });
    </script>
</body>

</html>
