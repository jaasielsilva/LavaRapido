<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout :: layout(~{::div})}">

<body>
    <div>
        <header>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Clientes</h1>
                    <div class="subtitle"
                        th:text="${cliente.id} == null ? 'Cadastro de novo cliente' : 'Edição de cliente'">
                        Cadastro de cliente
                    </div>
                </div>
                <a th:href="@{/clientes}" class="btn btn-secondary">
                    Voltar
                </a>
            </div>
        </header>

        <div class="box" style="max-width: 640px;">
            <div class="box-header">
                <h3 th:text="${cliente.id} == null ? 'Novo Cliente' : 'Editar Cliente'">Novo Cliente</h3>
            </div>

            <form th:action="@{/clientes/salvar}" th:object="${cliente}" method="post">
                <input type="hidden" th:field="*{id}" />

                <div class="mb-3" sec:authorize="hasRole('MASTER')">
                    <label for="empresa" class="form-label">Empresa</label>
                    <select id="empresa" class="form-select" th:field="*{empresa.id}" required>
                        <option value="" disabled th:selected="${cliente.empresa} == null">Selecione uma empresa
                        </option>
                        <option th:each="emp : ${empresas}" th:value="${emp.id}" th:text="${emp.nome}">
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="nome" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="nome" th:field="*{nome}" required>
                </div>

                <div class="mb-3">
                    <label for="telefone" class="form-label">Telefone</label>
                    <input type="text" class="form-control" id="telefone" th:field="*{telefone}">
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="email" th:field="*{email}">
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/clientes}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const telefoneInput = document.getElementById('telefone');

            const aplicarMascara = (value) => {
                if (!value) return "";
                value = value.replace(/\D/g, "");
                if (value.length > 11) value = value.slice(0, 11);

                if (value.length > 10) {
                    // (##) #####-####
                    value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
                } else if (value.length > 5) {
                    // (##) ####-####
                    value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
                } else if (value.length > 2) {
                    // (##) ####
                    value = value.replace(/^(\d{2})(\d{0,5}).*/, "($1) $2");
                } else if (value.length > 0) {
                    // (##
                    value = value.replace(/^(\d{0,2}).*/, "($1");
                }
                return value;
            };

            telefoneInput.addEventListener('input', function (e) {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                const oldValue = this.value;
                const newValue = aplicarMascara(this.value);

                this.value = newValue;

                // Simple validation feedback
                if (newValue.replace(/\D/g, '').length >= 10) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else if (newValue.length > 0) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-valid', 'is-invalid');
                }
            });

            // Prevent characters other than numbers
            telefoneInput.addEventListener('keypress', function (e) {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });

            // Apply mask on load if field is not empty
            if (telefoneInput.value) {
                telefoneInput.value = aplicarMascara(telefoneInput.value);
            }
        });
    </script>
</body>

</html>