<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::div})}">
<body>
    <div>
        <!-- =================================================================================== -->
        <!-- DASHBOARD GLOBAL (Exclusivo MASTER)                                                 -->
        <!-- =================================================================================== -->
        <div th:if="${showGlobalDashboard}">
            <header>
                <h1>Painel Master</h1>
                <div class="subtitle">Visão Global do SaaS</div>
            </header>

            <div class="cards">
                <div class="card blue">
                    <div class="card-info">
                        <h4>Empresas Ativas</h4>
                        <span class="number" th:text="${empresasAtivas}">0</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-building"></i>
                    </div>
                </div>

                <div class="card dark">
                    <div class="card-info">
                        <h4>Total de Veículos</h4>
                        <span class="number" th:text="${totalVeiculos}">0</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-car"></i>
                    </div>
                </div>

                <div class="card green">
                    <div class="card-info">
                        <h4>Usuários Online</h4>
                        <span class="number" th:text="${usuariosOnline}">0</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-signal"></i>
                    </div>
                </div>
            </div>

            <div class="grid-content">
                <div class="box full-width">
                    <div class="box-header">
                        <h3>Empresas Cadastradas</h3>
                        <i class="fa-solid fa-building"></i>
                    </div>
                    <div class="list">
                        <div class="item" th:each="emp : ${empresas}">
                            <div class="item-info">
                                <strong th:text="${emp.nome}">Nome Empresa</strong>
                                <div class="sub-info" th:text="${emp.cnpj}">CNPJ</div>
                            </div>
                            <div class="item-actions">
                                <span class="badge" th:classappend="${emp.ativo} ? 'bg-success' : 'bg-danger'"
                                      th:text="${emp.ativo ? 'Ativo' : 'Inativo'}">Status</span>
                                <a th:href="@{/dashboard(empresaId=${emp.id})}" class="btn btn-sm btn-outline-primary" title="Acessar Painel">
                                    <i class="fa-solid fa-arrow-right-to-bracket"></i> Painel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- =================================================================================== -->
        <!-- DASHBOARD OPERACIONAL (CLIENTE / TENANT / IMPERSONATE)                              -->
        <!-- =================================================================================== -->
        <div th:unless="${showGlobalDashboard}">
            <header>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>Dashboard</h1>
                        <div class="subtitle">
                            Visão geral do seu negócio 
                            <span th:if="${isMaster}" th:text="'(' + ${empresaContexto.nome} + ')'" class="badge bg-warning text-dark"></span>
                        </div>
                    </div>
                    <div th:if="${isMaster}">
                        <a th:href="@{/dashboard}" class="btn btn-outline-secondary btn-sm">
                            <i class="fa-solid fa-arrow-left"></i> Voltar para Global
                        </a>
                    </div>
                </div>
            </header>

            <div class="cards">
                <div class="card blue">
                    <div class="card-info">
                        <h4>Clientes Cadastrados</h4>
                        <span class="number" th:text="${clientesCadastrados}">3</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-users"></i>
                    </div>
                </div>

                <div class="card orange">
                    <div class="card-info">
                        <h4>Agendamentos Pendentes</h4>
                        <span class="number" th:text="${agendamentosPendentes}">0</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-calendar-days"></i>
                    </div>
                </div>

                <div class="card dark">
                    <div class="card-info">
                        <h4>Serviços Hoje</h4>
                        <span class="number" th:text="${servicosHoje}">0</span>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-car"></i>
                    </div>
                </div>

                <div class="card green" sec:authorize="hasAnyRole('MASTER','ADMIN')">
                    <div class="card-info">
                        <h4>Faturamento Hoje</h4>
                        <span class="number"
                              th:text="'R$ ' + ${#numbers.formatDecimal(faturamentoHoje != null ? faturamentoHoje : 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                        <div class="stat">
                            <span class="up text-success"
                                  th:if="${faturamentoSubiu}"
                                  th:text="'↑ ' + ${#numbers.formatDecimal(faturamentoVariacaoAbsoluta != null ? faturamentoVariacaoAbsoluta : 0, 1, 'POINT', 1, 'COMMA')} + '%'">↑ 0%</span>
                            <span class="down text-danger"
                                  th:if="${faturamentoCaiu}"
                                  th:text="'↓ ' + ${#numbers.formatDecimal(faturamentoVariacaoAbsoluta != null ? faturamentoVariacaoAbsoluta : 0, 1, 'POINT', 1, 'COMMA')} + '%'">↓ 0%</span>
                            <span class="muted"
                                  th:if="${!faturamentoSubiu and !faturamentoCaiu}">0%</span>
                            <span class="muted">vs. ontem</span>
                        </div>
                    </div>
                    <div class="icon-box">
                        <i class="fa-solid fa-dollar-sign"></i>
                    </div>
                </div>
            </div>

            <div class="grid-content">
                <!-- SERVIÇOS DE HOJE -->
                <div class="box">
                    <div class="box-header">
                        <h3>Serviços de Hoje</h3>
                        <i class="fa-regular fa-clock"></i>
                    </div>

                    <div class="list">
                        <div th:if="${servicosHojeLista == null or servicosHojeLista.isEmpty()}" class="text-center py-4">
                            <span class="text-muted">Nenhum serviço realizado hoje.</span>
                        </div>

                        <div class="item" th:each="s : ${servicosHojeLista}">
                            <div class="item-info">
                                <strong th:text="${s.nomeClienteDisplay}">Nome do Cliente</strong>
                                <div class="sub-info" th:text="${s.veiculoDisplay}">Modelo - Placa</div>
                                <div class="service-type"
                                     th:text="${s.servico != null ? s.servico.nome : s.nomeServicoHistorico}">Tipo de serviço</div>
                            </div>
                            <div class="item-actions">
                                <span class="badge"
                                      th:classappend="' bg-' + ${s.status.cor}"
                                      th:text="${s.status.descricao}">Status</span>
                                <span class="price"
                                      th:text="'R$ ' + ${#numbers.formatDecimal(s.valor != null ? s.valor : (s.servico != null ? s.servico.preco : 0), 1, 'POINT', 2, 'COMMA')}">
                                    R$ 0,00
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="box-footer text-center mt-3 border-top pt-3 border-secondary border-opacity-10">
                        <a th:href="@{/servicos-avulsos}" class="text-info text-decoration-none small fw-bold">
                            Ver todos os serviços <i class="fa-solid fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>

                <!-- PRÓXIMOS AGENDAMENTOS -->
                <div class="box">
                    <div class="box-header">
                        <h3>Próximos Agendamentos</h3>
                        <i class="fa-regular fa-circle-check"></i>
                    </div>

                    <div class="list">
                        <div th:if="${proximosAgendamentos == null or proximosAgendamentos.isEmpty()}" class="text-center py-4">
                            <span class="text-muted">Nenhum agendamento futuro.</span>
                        </div>

                        <div class="item" th:each="ag : ${proximosAgendamentos}">
                            <div class="item-info">
                                <strong th:text="${ag.veiculo.cliente.nome}">Nome Cliente</strong>
                                <div class="sub-info">
                                    <span th:text="${ag.veiculo.modelo}">Modelo</span> - 
                                    <span th:text="${ag.veiculo.placa}">Placa</span>
                                </div>
                                <div class="service-type" th:text="${ag.servicos}">Serviços</div>
                            </div>
                            <div class="item-actions">
                                <div class="date-info">
                                    <span th:text="${#temporals.format(ag.data, 'dd/MM/yyyy')}">Data</span>
                                    <span th:text="${#temporals.format(ag.data, 'HH:mm')}">Hora</span>
                                </div>
                                <span class="price" th:text="'R$ ' + ${#numbers.formatDecimal(ag.valor != null ? ag.valor : 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="box-footer text-center mt-3 border-top pt-3 border-secondary border-opacity-10">
                        <a th:href="@{/agendamentos}" class="text-info text-decoration-none small fw-bold">
                            Ver todos os agendamentos <i class="fa-solid fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
